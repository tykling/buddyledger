{% extends "skeleton.html" %}
{% load custom_filters %}

{% block content %}

<div class="tabbable">
    <ul class="nav nav-tabs">
        <li class="active"><a href="#main" data-toggle="tab">Main</a></li>
        <li><a href="#people" data-toggle="tab">People</a></li>
        <li><a href="#expenses" data-toggle="tab">Expenses</a></li>
            {% if expenses and resultdict.total %}
                <li><a href="#resulttable" data-toggle="tab">Result (table)</a></li>
                <li><a href="#resultlist" data-toggle="tab">Result (list)</a></li>
            {% endif %}
        <li><a href="#debug" data-toggle="tab">Debug info</a></li>
    </ul>

    <div class="tab-content">
        <div id="main" class="tab-pane active">
            <h2>{{ ledger.name }}</h2>
            <span class="label label-success">Native currency: {{ ledger.currency }}</span>
            <p>This is <b>BuddyLedger</b>, a system to keep track of expenses between groups of people. 
            Given a list of people and expenses this system will calculate the final breakdown so you can see who owes what to whom.</p>
            
            <h2>Statistics</h2>
            <p>This ledger has <b>{{ people|length }}</b> people and <b>{{ expenses|length }}</b> with a total of <b>{{ payments|length }}</b> payments.</p>
            
            <h2>Advanced Settings</h2>
            <p>You can change the algorithm used to calculate the final result. The default should be fine for most uses.</p>
            <a href="/ledger/{{ ledger.id }}/changemethod/" class="btn btn-inverse"><i class="icon-wrench"></i> Change method</a>

            
            <h2>Close Ledger</h2>
            <p>When all expenses and payments has been added to the ledger it should be closed before any backpayments can be registered.</p>
            <a href="/ledger/{{ ledger.id }}/close/" class="btn btn-danger"><i class="icon-check"></i> Close Ledger</a>
        </div>
        
        <div id="people" class="tab-pane">
            {% comment %}<!-- List of people -->{% endcomment %}
            <h3>People:</h3>
            {% if people %}
                <a href="/ledger/{{ ledger.id }}/addperson/" class="btn btn-primary"><i class="icon-plus"></i> Add person</a>
                <table class="table table-bordered table-striped" style="width: 50%;">
                    <tr><th>Name</th><th style="width: 5em; text-align: center">Edit</th><th style="width: 5em; text-align: center">Remove</th></tr>
                    {% for person in people %}
                    <tr><td>{{ person.name }}</td>  
                        <td style="width: 5em; text-align: center"><a href="/person/{{ person.id }}/edit/" class="btn btn-info btn-mini"><i class="icon-edit"></i></a></td>
                        <td style="width: 5em; text-align: center"><a href="/person/{{ person.id }}/remove/" class="btn btn-danger btn-mini"><i class="icon-remove"></i></a></td>
                    </tr>
                    {% endfor %}
                </table>
            {% else %}
                <p class="text-warning">No people found connected to this ledger. First you need to add all the people 
                involved in this ledger by pressing the button below! This includes both the people who put up money for the expenses, 
                and the people who owes money to them.</p>
                <a href="/ledger/{{ ledger.id }}/addperson/" class="btn btn-primary"><i class="icon-plus"></i> Add person</a>
            {% endif %}        
        </div>

        <div id="expenses" class="tab-pane">
            {% if expenses %}
                <a href="/ledger/{{ ledger.id }}/addexpense/" class="btn btn-primary">Add expense</a>
                <table class="table table-bordered">
                    <tr>
                        <th>Name</th>
                        <th style="width: 3em; text-align: center">Amount</th>
                        <th style="width: 3em; text-align: center">Amount {{ ledger.currency.iso4217_code }}</th>
                        <th>Payments</th>
                        <th>In</th>
                        <th>Not in</th>
                        <th style="width: 4em; text-align: center">Action</th>
                    </tr>
                {% for expense in expenses %}
                    <tr><td>{{ expense.name }}</td>
                    <td>{{ expense.amount }} {{ expense.currency.iso4217_code }}</td>
                    <td>{{ expense.amount_native }} {{ ledger.currency.iso4217_code }}</td>
                    <td>
                    {% if payments|length_is:"0" %}
                        <p class="warning">No payments registered for this expense! Who paid for this ?</p>
                    {% else %}
                        {% for payment in payments %}
                            {% if payment.expense_id = expense.id %}
                                {{ payment.person.name }}: {{ payment.amount }} {{ payment.currency.iso4217_code }}&nbsp;&nbsp;
                                <a href="/payment/{{ payment.id }}/remove/" class="btn btn-danger btn-mini pull-right"><i class="icon-remove"></i></a> 
                                <a href="/payment/{{ payment.id }}/edit/" class="btn btn-info btn-mini pull-right"><i class="icon-edit"></i></a><br>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    <a href="/expense/{{expense.id}}/addpayment" class="btn btn-mini btn-success"><i class="icon-plus"></i> Add new payment</a><br>
                    </td>

                    <td>
                    {% for person in expense.people.all %}
                        <p>{{ person.name }} <a href="/expense/{{ expense.id }}/removeperson/{{ person.id }}/" class="btn btn-mini btn-danger pull-right"><i class="icon-remove"></i></a></p>
                    {% endfor %}
                    </td>
                    <td>
                    {% for person in people %}
                        {% if person not in expense.people.all %}
                            <p>{{ person.name }} <a href="/expense/{{ expense.id }}/addperson/{{ person.id }}/" class="btn btn-mini btn-success pull-right"><i class="icon-plus"></i></a></p>
                        {% endif %}
                    {% endfor %}
                    </td>
                    <td style="width: 3em; text-align: center">
                    <a href="/expense/{{ expense.id }}/edit/" class="btn btn-info btn-mini"><i class="icon-edit"></i></a>
                    <a href="/expense/{{ expense.id }}/remove/" class="btn btn-danger btn-mini"><i class="icon-remove"></i></a>
                    </td>
                    </tr>
                {% endfor %}
                </table>
                <a href="/ledger/{{ ledger.id }}/addexpense/" class="btn btn-primary">Add expense</a>
            {% else %}
                <p class="text-warning">No expenses found. After adding people above, you need to add the expenses for this ledger by pressing the button below. 
                You should also choose the people who should be charged for the expense when creating it. 
                After adding an expense you need to add one or more payments for the expense, depending on how many people actually paid for the expense.</p>
                {% if people %}
                    <a href="/ledger/{{ ledger.id }}/addexpense/" class="btn btn-primary">Add expense</a>
                {% else %}
                    <button class="btn btn-primary btn-disabled" disabled>Add expense</button>
                {% endif %}
            {% endif %}
        </div>

        <div id="resulttable" class="tab-pane">
            {% comment %}<!-- Result table -->{% endcomment %}
            <table class="table table-bordered">
            {% comment %}<!-- First create the top row -->{% endcomment %}
            <tr>
                {% comment %}<!-- Upper left corner black cell -->{% endcomment %}
                <th style="color: black; background-color: black">&nbsp;</th>
                {% comment %}<!-- Create TH row -->{% endcomment %}
                {% for uid,tablerow in resultdict.items %}
                    {% if uid == "total" %}
                        {% comment %}<!-- This is the top rightmost cell -->{% endcomment %}
                        <th>Total receive</th>
                    {% else %}
                        {% comment %}<!-- This is a regular toprow cell -->{% endcomment %}
                        <th>{{ data.userdict|keyvalue:uid }} pay</th>
                    {% endif %}
                {% endfor %}
            </tr>

            {% comment %}<!-- Loop through the receiver rows -->{% endcomment %}
            {% for uid,tablerow in resultdict.items %}
                {% comment %}<!-- Create header row -->{% endcomment %}
                <tr>
                    {% if uid == "total" %}
                        {% comment %}<!-- This is the bottom leftmost cell -->{% endcomment %}
                        <td><b>Total pay</b></td>
                    {% else %}
                        {% comment %}<!-- This is a regular leftmost column cell -->{% endcomment %}
                        <td><b>{{ data.userdict|keyvalue:uid }} receive</b></td>
                    {% endif %}

                    {% comment %}<!-- Loop through the cells of this row -->{% endcomment %}
                    {% for tempuid,value in tablerow.items %}
                        {% comment %}<!-- if value is "n/a" paint the cell black (for payment from/to the same user) -->{% endcomment %}
                        {% if value == "n/a" %}
                            <td style="color: black; background-color: black">&nbsp;</td>
                            {% comment %}<!-- if value is 0 make the cell dark grey -->{% endcomment %}
                        {% elif value == 0 %}
                            <td style="color: darkgrey; background-color: darkgrey"><i>n/a</i></td>
                            {% comment %}<!-- check if this is the rightmost totals row, make bold if so -->{% endcomment %}
                        {% elif tempuid == "total" %}
                            <td><b>{{ value }} {{ ledger.currency.iso4217_code }}</b></td>
                        {% else %}
                            {% comment %}<!-- Check if this is the bottom totals row, make bold if so -->{% endcomment %}
                            {% if uid == "total" %}
                                <td><b>{{ value }} {{ ledger.currency.iso4217_code }}</b></td>
                            {% else %}
                                <td>{{ value }} {{ ledger.currency.iso4217_code }}</td>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    {% comment %}<!-- If this is the bottom (totals) row, it is missing the rightmost (totals) column, so add an extra black cell here -->{% endcomment %}
                    {% if uid == "total" %}
                        {% comment %}<!-- This is the bottom row, add the missing cell -->{% endcomment %}
                        <td style="color: black; background-color: black">&nbsp;</td>
                    {% endif %}
                </tr>
            {% endfor %}
            </table>
        </div>

        <div id="resultlist" class="tab-pane">
            <table class="table table-hover table-bordered">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Receive</th>
                        <th>Pay</th>
                    </tr>
                </thead>
                <tbody>
                    {% for uid,tablerow in resultdict.items %}
                        {% if uid != "total"%}
                            <tr>
                                <td>{{ data.userdict|keyvalue:uid }}</td>
                                <td>
                                    <ul>
                                        {% comment %}<!-- Loop through the people that owe this user money -->{% endcomment %}
                                        {% for tempuid,value in tablerow.items %}
                                            {% if tempuid != uid and tempuid != "total"%}
                                                {% if value > 0 %}
                                                    <li>Collect {{ value }} {{ ledger.currency.iso4217_code }} from {{ data.userdict|keyvalue:tempuid }}</li>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </td>
                                <td>
                                    <ul>
                                        {% comment %}<!-- Loop through the people that this user owes money to -->{% endcomment %}
                                        {% for tempuid,temprow in resultdict.items %}
                                            {% if tempuid != uid and tempuid != "total" %}
                                                {% for uid2,value in temprow.items %}
                                                    {% if uid2 == uid and uid2 != "total" %}
                                                        {% if value > 0 %}
                                                            <li>Pay {{ value }} {{ ledger.currency.iso4217_code }} to {{ data.userdict|keyvalue:tempuid }}</li>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="debug" class="tab-pane">
          <h4>Debug</h4>
          <p><pre>{{ data }}</pre></p>
        </div>
    </div><!-- /.tab-content -->
</div><!-- /.tabbable -->
{% endblock %}
