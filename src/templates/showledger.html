{% extends "skeleton.html" %}
{% load custom_filters %}

{% block content %}
<h2>Ledger: {{ ledger.name }}</h2>
<div class="alert alert-info"><b>Native currency: {{ ledger.currency }}</b></div>


{% comment %}<!-- List of people -->{% endcomment %}
<h3>People:</h3>
{% if people %}
<p>{{ people|join:", " }}</p>
<button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#peopledetails"><i class="icon-list"></i> Details</button>
<a href="/ledger/{{ ledger.id }}/addperson/" class="btn btn-primary"><i class="icon-plus"></i> Add person</a>
<div id="peopledetails" class="collapse">
    <table class="table table-bordered table-striped" style="width: 50%;">
        <tr><th>Name</th><th style="width: 5em; text-align: center">Edit</th><th style="width: 5em; text-align: center">Remove</th></tr>
        {% for person in people %}
        <tr><td>{{ person.name }}</td>  
            <td style="width: 5em; text-align: center"><a href="/person/{{ person.id }}/edit/" class="btn btn-info btn-mini"><i class="icon-edit"></i></a></td>
            <td style="width: 5em; text-align: center"><a href="/person/{{ person.id }}/remove/" class="btn btn-danger btn-mini"><i class="icon-remove"></i></a></td>
        </tr>
        {% endfor %}
    </table>
</div>
{% else %}
<p class="text-warning">No people found!</p>
{% endif %}

<hr>

{% comment %}<!-- List of expenses -->{% endcomment %}
<h3>Expenses:</h3>
{% if expenses %}
<button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#expensedetails"><i class="icon-list"></i> Details</button>
<a href="/ledger/{{ ledger.id }}/addexpense/" class="btn btn-primary">Add expense</a>
<div id="expensedetails" class="collapse">
<table class="table table-bordered">
<tr>
    <th>Name</th>
    <th style="width: 3em; text-align: center">Amount</th>
    <th style="width: 3em; text-align: center">Amount {{ ledger.currency.iso4217_code }}</th>
    <th>Payments</th>
    <th>In</th>
    <th>Not in</th>
    <th style="width: 4em; text-align: center">Action</th>
</tr>
{% for expense in expenses %}
<tr><td>{{ expense.name }}</td>
<td>{{ expense.amount }} {{ expense.currency.iso4217_code }}</td>
<td>{{ expense.amount_native }} {{ ledger.currency.iso4217_code }}</td>
<td>
{% if payments|length_is:"0" %}
<p class="warning">No payments registered for this expense! Who paid for this ?</p>
{% else %}
{% for payment in payments %}
{% if payment.expense_id = expense.id %}
{{ payment.person.name }}: {{ payment.amount }} {{ payment.currency.iso4217_code }}&nbsp;&nbsp;
<a href="/payment/{{ payment.id }}/remove/" class="btn btn-danger btn-mini pull-right"><i class="icon-remove"></i></a> 
<a href="/payment/{{ payment.id }}/edit/" class="btn btn-info btn-mini pull-right"><i class="icon-edit"></i></a><br>
{% endif %}
{% endfor %}
{% endif %}
<a href="/expense/{{expense.id}}/addpayment" class="btn btn-mini btn-success"><i class="icon-plus"></i> Add new payment</a><br>
</td>

<td>
{% for person in expense.people.all %}
<p>{{ person.name }} <a href="/expense/{{ expense.id }}/removeperson/{{ person.id }}/" class="btn btn-mini btn-danger pull-right"><i class="icon-remove"></i></a></p>
{% endfor %}
</td>
<td>
{% for person in people %}
    {% if person not in expense.people.all %}
        <p>{{ person.name }} <a href="/expense/{{ expense.id }}/addperson/{{ person.id }}/" class="btn btn-mini btn-success pull-right"><i class="icon-plus"></i></a></p>
    {% endif %}
{% endfor %}
</td>
<td style="width: 3em; text-align: center">
<a href="/expense/{{ expense.id }}/edit/" class="btn btn-info btn-mini"><i class="icon-edit"></i></a>
<a href="/expense/{{ expense.id }}/remove/" class="btn btn-danger btn-mini"><i class="icon-remove"></i></a>
</td>
</tr>
{% endfor %}
</table>
</div>
{% else %}
<p class="text-warning">No expenses found!</p>
{% endif %}

<hr>

<h3>Result:</h3>
<div class="tabbable">
  <ul class="nav nav-tabs">
    <li class="active"><a href="#table" data-toggle="tab">Table</a></li>
    <li><a href="#list" data-toggle="tab">List</a></li>
    <li><a href="#detail" data-toggle="tab">Detail</a></li>
  </ul>
  <div class="tab-content">
    <div id="table" class="tab-pane active">
        {% comment %}<!-- Result table -->{% endcomment %}
        <table class="table table-bordered">
        {% comment %}<!-- First create the top row -->{% endcomment %}
        <tr>
        {% comment %}<!-- Upper left corner black cell -->{% endcomment %}
        <th style="color: black; background-color: black">&nbsp;</th>
        {% comment %}<!-- Create TH row -->{% endcomment %}
        {% for uid,tablerow in resultdict.items %}
            {% if uid == "total" %}
            {% comment %}<!-- This is the top rightmost cell -->{% endcomment %}
            <th>Total receive</th>
            {% else %}
            {% comment %}<!-- This is a regular toprow cell -->{% endcomment %}
            <th>{{ data.userdict|keyvalue:uid }} pay</th>
            {% endif %}
        {% endfor %}
        </tr>

        {% comment %}<!-- Loop through the receiver rows -->{% endcomment %}
        {% for uid,tablerow in resultdict.items %}
            {% comment %}<!-- Create header row -->{% endcomment %}
            <tr>
            {% if uid == "total" %}
            {% comment %}<!-- This is the bottom leftmost cell -->{% endcomment %}
            <td><b>Total pay</b></td>
            {% else %}
            {% comment %}<!-- This is a regular leftmost column cell -->{% endcomment %}
            <td><b>{{ data.userdict|keyvalue:uid }} receive</b></td>
            {% endif %}

            {% comment %}<!-- Loop through the cells of this row -->{% endcomment %}
            {% for tempuid,value in tablerow.items %}
                {% comment %}<!-- if value is "n/a" paint the cell black (for payment from/to the same user) -->{% endcomment %}
                {% if value == "n/a" %}
                <td style="color: black; background-color: black">&nbsp;</td>
                {% comment %}<!-- if value is 0 make the cell dark grey -->{% endcomment %}
                {% elif value == 0 %}
                <td style="color: darkgrey; background-color: darkgrey"><i>n/a</i></td>
                {% comment %}<!-- check if this is the rightmost totals row, make bold if so -->{% endcomment %}
                {% elif tempuid == "total" %}
                <td><b>{{ value }} {{ ledger.currency.iso4217_code }}</b></td>
                {% else %}
                {% comment %}<!-- Check if this is the bottom totals row, make bold if so -->{% endcomment %}
                {% if uid == "total" %}
                <td><b>{{ value }} {{ ledger.currency.iso4217_code }}</b></td>
                {% else %}
                <td>{{ value }} {{ ledger.currency.iso4217_code }}</td>
                {% endif %}
                {% endif %}
            {% endfor %}
            {% comment %}<!-- If this is the bottom (totals) row, it is missing the rightmost (totals) column, so add an extra black cell here -->{% endcomment %}
            {% if uid == "total" %}
            {% comment %}<!-- This is the bottom row, add the missing cell -->{% endcomment %}
            <td style="color: black; background-color: black">&nbsp;</td>
            {% endif %}
            </tr>
        {% endfor %}
        </table>
    </div>
    <div id="list" class="tab-pane">
        <table class="table table-hover table-bordered">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Receive</th>
                    <th>Pay</th>
                </tr>
            </thead>
            <tbody>
                {% for uid,tablerow in resultdict.items %}
                    {% if uid != "total"%}
                        <tr>
                            <td>{{ data.userdict|keyvalue:uid }}</td>
                            <td>
                                <ul>
                                    {% comment %}<!-- Loop through the people that owe this user money -->{% endcomment %}
                                    {% for tempuid,value in tablerow.items %}
                                        {% if tempuid != uid and tempuid != "total"%}
                                            {% if value > 0 %}
                                                <li>Collect {{ value }} {{ ledger.currency.iso4217_code }} from {{ data.userdict|keyvalue:tempuid }}</li>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </td>
                            <td>
                                <ul>
                                    {% comment %}<!-- Loop through the people that this user owes money to -->{% endcomment %}
                                    {% for tempuid,temprow in resultdict.items %}
                                        {% if tempuid != uid and tempuid != "total" %}
                                            {% for uid2,value in temprow.items %}
                                                {% if uid2 == uid and uid2 != "total" %}
                                                    {% if value > 0 %}
                                                        <li>Pay {{ value }} {{ ledger.currency.iso4217_code }} to {{ data.userdict|keyvalue:tempuid }}</li>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div id="detail" class="tab-pane">
      <h4>Details..</h4>
    </div>
  </div><!-- /.tab-content -->
</div><!-- /.tabbable -->

<hr>

{% comment %}<!-- Debug info -->{% endcomment %}
<button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#debuginfo"><i class="icon-info-sign"></i> Debug info</button>
<div id="debuginfo" class="collapse">
<p>
<pre>{{ data }}</pre>
</p>
</div>
{% endblock %}
