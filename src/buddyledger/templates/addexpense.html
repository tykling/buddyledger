7{% extends "skeleton.html" %}

{% block content %}
<h2>Add expense to ledger</h2>

{% if form.errors %}
	<div class="alert alert-error">
		<h4>Form errors</h4>
		<ol>
			{% for error in form.errors %}
				<li><strong>{{ error|escape }}</strong></li>
			{% endfor %}
		</ol>
	</div>
{% endif %}

<form method="POST">
    {% csrf_token %}
    <div class="row">
        <div class="span4">
            <table>
                <tr><td>{{form.name.label_tag}}</td><td><div class="control-group">{{form.name}}</td></tr>
                <tr><td>{{form.amount.label_tag}}</td><td><div class="control-group" id="controlgroup-amount">{{form.amount}}</td></tr>
                <tr><td>{{form.currency.label_tag}}</td><td><div class="control-group">{{form.currency}}</td></tr>
            </table>
        </div>
        <div class="span6">
            <div class="alert" id="messages">
                <p>Add an expense!</p>
            </div>
        </div>
    </div>
    
    <div class="row">
        <h4>People</h4>
        
        <div class="span2" id="peoplebox">
            <div class="alert alert-info">
                {% for person in people %}
                    <p class="personp" style="text-align: center;" id="buttonp-{{ person.id }}">
                        <button class="btn btn-primary btn-mini personbutton" type="button" onclick="javascript:showrow({{person.id}});">{{ person.name }} <i class="icon-arrow-right"></i></button>
                    </p>
                {% endfor %}
            </div>
        </div>
        
        <div class="span4">    
            <table class="table table-condensed">
                <tr><th>Person</th><th>Amount owed</th><th>Amount paid</th></tr>
                {% for person in people %}
                <tr style="display: none;" id="row{{person.id}}">
                    <td>
                        <div class="controls form-inline">
                            <button class="btn btn-primary btn-mini" type="button" onclick="javascript:hiderow({{person.id}});"><i class="icon-arrow-left"></i> {{ person.name }}</button>
                            <input id="expensepart-{{person.id}}" name="person-expensepart-{{person.id}}" type="checkbox" style="display:none;"/>
                        </div>
                    </td>

                    <td>
                        <div id="controlgroup-customamount-{{person.id}}" class="control-group">
                            <div class="controls">
                                <div class="input-append">
                                    <input id="customamount-{{person.id}}" class="input-mini" name="person-customamount-{{person.id}}" class="uneditable-input" type="number" disabled>
                                    <input id="autoamount-{{person.id}}" name="person-autoamount-{{person.id}}" type="checkbox" checked style="display:none;">
                                    <button id="customamount-button-{{person.id}}" class="btn btn-primary btn-mini" type="button" onclick="javascript:toggleautoamount({{person.id}});"><i class="icon-edit"></i> Specify amount</button>
                                    <button id="autoamount-button-{{person.id}}" class="btn btn-info btn-mini" type="button" onclick="javascript:toggleautoamount({{person.id}});"><i class="icon-star-empty"></i> Calculate amount</button>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div id="controlgroup-paymentamount-{{person.id}}" class="control-group">
                            <div class="controls">
                                <div class="input-append">
                                    <input id="paymentamount-{{person.id}}" class="input-mini" name="person-paymentamount-{{person.id}}" type="number" value="0">
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    <input type="submit" method="POST" class="btn" value="Add expense" disabled>
</form>

<script>
    function showrow(userid) {
        $( '#row'+userid ).show();
        $( '#expensepart-'+userid ).prop("checked", true);
        $( '#buttonp-'+userid ).hide();
        updatecalc();
        
        // find out if all rows are now hidden, hide the whole table if so
        var temp = "allhidden";
        $( ".personp" ).each(function( index ) {
            if( $( this ).css("display") != "none" ) {
                temp = "atleastoneisvisible";
            };
        });
        if(temp == "atleastoneisvisible") {
            $( "#peoplebox" ).show();
        } else {
            $( "#peoplebox" ).hide();
        };
    };

    function hiderow(userid) {
        $( '#row'+userid ).hide();
        $( '#expensepart-'+userid ).prop("checked", false);
        $( '#buttonp-'+userid ).show();
        updatecalc();
        
        // show the box if it is hidden
        if( $( "#peoplebox" ).css("display") == "none") {
            $( "#peoplebox" ).show();
        };
    };
    
    function toggleautoamount(id) {
        // if checkbox is checked...
        if ( $( '#autoamount-'+id ).prop( "checked" ) ) {
            // enable textbox
            document.getElementById("customamount-"+id).className="";
            document.getElementById("customamount-"+id).disabled="";
        } else {
            // disable textbox
            document.getElementById("customamount-"+id).className="uneditable-input";
            document.getElementById("customamount-"+id).disabled="disabled";
        };

        // toggle checkbox
        $( '#autoamount-'+id ).click();
        
        // toggle button visibility
        $( '#customamount-button-'+id ).toggle();
        $( '#autoamount-button-'+id ).toggle();

        // update calculation
        updatecalc();
    };
    
    function setMessage(message,type) {
        $( '#messages' ).removeClass().addClass( "alert " + type );
        $( '#messages' ).html("<p>" + message + "</p>");
    };
    
    function updatecalc() {
        setMessage("Working...","alert-info")
        
        // check if we have a valid total expense amount in the form
        if(!$.isNumeric(document.getElementById('amount').value)) {
            $( '#controlgroup-amount' ).removeClass().addClass( "control-group error" );
            setMessage("Invalid expense amount specified","alert-error");
            return;
        } else {
            $( '#controlgroup-amount' ).removeClass().addClass( "control-group" );
        };
        
        // check each of the customamount fields
        var success = true;
        $( "input[name^='person-customamount-']" ).each(function( index ) {
            // find userid from element name
            userid = $(this).attr( "name" ).substring(20);
            // is this user a part of this expense ?
            if (document.getElementById('expensepart-'+userid).checked == true) {
                // remove any extra classes on this control group
                $( '#controlgroup-customamount-'+userid ).removeClass().addClass( "control-group" );
                // is autoamount unchecked ?
                if (document.getElementById('autoamount-'+userid).checked == false) {
                    // check if the value is numeric
                    if ( !$.isNumeric( $( this ).val() ) ) {
                        setMessage("Invalid amount specified: " + $(this).val(),"alert-error");
                        $( '#controlgroup-customamount-'+userid ).removeClass().addClass( "control-group error" );
                        success = false;
                        return;
                    };
                };
            };
        });
        if(!success) {
            return;
        };
        
        // find the userids of customamount and autoamount people in this calculation
        var autoids = new Array();
        var customids = new Array();
        $( "input[name^='person-customamount-']" ).each(function( index ) {
            // find userid from element name
            userid = $(this).attr( "name" ).substring(20);
            if (document.getElementById('expensepart-'+userid).checked == true) {
                if (document.getElementById('autoamount-'+userid).checked == true) {
                    autoids.push(userid);
                } else {
                    customids.push(userid);
                };
            };
        });
        
        if(customids.length + autoids.length == 0) {
            setMessage("No people selected","alert-error");
            return;
        };
        
        // arrays autoids and customids now contain the userid's for the calculation,
        // first do some sanity checking to check that the customamounts are less than the total expense amount
        customtotal = 0;
        if (customids.length > 0) {
            for (var i=0;i<customids.length;i++) {
                customtotal = customtotal + parseFloat($( "#customamount-" + customids[i] ).val());
            };
        };
        
        // if the total customamount exceeds the amount...
        if (customtotal > document.getElementById('amount').value) {
            // mark the expense amount and the customamount fields with red to indicate where the problem is
            document.getElementById('controlgroup-amount').className="control-group error";
            $( "input[name^='person-customamount-']" ).each(function( index ) {
                // only mark fields with non-zero value in red
                if(this.value != '' && this.value != 0) {
                    // find userid from element name
                    userid = $(this).attr( "name" ).substring(20);
                    // mark this field red (class goes on the controlgroup not the field)
                    document.getElementById('controlgroup-customamount-'+userid).className="control-group error";
                };
            });
            setMessage("Custom amounts total exceeds expense amount","alert-error");
            return;
        };
        
        // now find the amount that remains after custom amounts have been substracted,
        // divide by the number of autoamount people, and add it to their amount textboxes
        divamount = (document.getElementById('amount').value-customtotal)/autoids.length;
        $( "input[name^='person-customamount-']" ).each(function( index ) {
            // find userid from element name
            userid = $(this).attr( "name" ).substring(20);
            if (document.getElementById('expensepart-'+userid).checked == true) {
                if (document.getElementById('autoamount-'+userid).checked == true) {
                    document.getElementById('customamount-'+userid).value = divamount;
                };
            };
        });
        
        setMessage("Calculation OK!","alert-success");
    };
    
    $().ready(function(){
        // update calculation on input and change
        $( "#amount" ).on('input change',function() {
            updatecalc();
        });
        $( "input[name^='person-customamount-']" ).on('input change',function() {
            updatecalc();
        });
        
        
        // reset form
        $( "input[name^='person-customamount-']" ).each(function( index ) {
            // find userid from element name
            userid = $(this).attr( "name" ).substring(20);
            
            // empty textfield
            $( "#customamount-"+userid ).val('');
            
            // add uneditable-input and disabled to the customamount textfield
            $( "#customamount-"+userid ).addClass("uneditable-input");
            $( "#customamount-"+userid ).prop( "disabled", true );
            
            // uncheck expensepart
            $( "#expensepart-"+userid ).prop("checked", false);
            $( "#expensepart-" + userid + " + a" ).removeClass("checked");
            
            // check autoamount
            $( "#autoamount-"+userid ).prop("checked", true);
            $( "#autoamount-" + userid + " + a" ).addClass("checked");
            
            // hide and show autoamount buttons
            $( '#customamount-button-'+userid ).show();
            $( '#autoamount-button-'+userid ).hide();
        });

        // initial calculation
        updatecalc();
    });
</script>
{% endblock %}